name: Security Scanning

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scans (Monday at 9 AM UTC)
    - cron: '0 9 * * 1'
  workflow_dispatch:

# Set minimal permissions
permissions:
  contents: read

jobs:
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@4a20c8b69d025d0c91ec010e1dcd68f3a28bc18b # v2.3.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: false

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run OSV-Scanner
        uses: google/osv-scanner-action@5a0f5ffe4b3e8c4d96a17f5ec6a609b78e85f86d # v1.9.1
        with:
          scan-args: |
            --lockfile=platformio.ini
            --format=json
            --output=osv-results.json
        continue-on-error: true

      - name: Upload OSV scan results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: osv-scan-results
          path: osv-results.json
          retention-days: 30

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'c-cpp' ]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Initialize CodeQL
        uses: github/codeql-action/init@662472033e021d55d94146f66f6058822889cafe # v3.27.9
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio==6.1.16

      - name: Build with PlatformIO (for CodeQL)
        run: |
          pio run --environment esp32-devkit
        continue-on-error: true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@662472033e021d55d94146f66f6058822889cafe # v3.27.9
        with:
          category: "/language:${{matrix.language}}"
          upload: true
