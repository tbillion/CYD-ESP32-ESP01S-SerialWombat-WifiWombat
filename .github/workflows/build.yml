name: Build and Test

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# Set minimal permissions by default
permissions:
  contents: read

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    strategy:
      matrix:
        environment:
          - esp32-s3-devkit
          - esp32-devkit
          - esp32-2432S028
          - esp32-8048S070
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Cache PlatformIO
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio==6.1.16

      - name: Build firmware (${{ matrix.environment }})
        run: |
          pio run --environment ${{ matrix.environment }}
        env:
          PLATFORMIO_BUILD_FLAGS: -DPIO_FRAMEWORK_ARDUINO_ENABLE_EXCEPTIONS

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: firmware-${{ matrix.environment }}
          path: .pio/build/${{ matrix.environment }}/firmware.bin
          retention-days: 30
          if-no-files-found: error

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run clang-format check
        uses: jidicula/clang-format-action@6cd220de46c89139a0365edae93eee8eb30ca8fe # v4.16.0
        with:
          clang-format-version: '18'
          check-path: '.'
          fallback-style: 'Google'
          exclude-regex: '(\.pio|\.git|docs)'
