name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # MUST be named exactly this or Copilot won't pick it up
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Keep permissions minimal; contents:read is needed if we checkout.
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install -U platformio
          pio --version

      # Cache PlatformIO downloads (frameworks/toolchains/libs) so Copilot builds are reliable and fast.
      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
          key: ${{ runner.os }}-platformio-${{ hashFiles('**/platformio.ini', '**/platformio.lock', '**/lib_deps/**', '**/pio.*') }}
          restore-keys: |
            ${{ runner.os }}-platformio-

      # Pre-fetch toolchains/frameworks so the agent doesn't time out doing it later.
      - name: PlatformIO - Preinstall packages (best effort)
        shell: bash
        run: |
          if [ -f "platformio.ini" ]; then
            echo "platformio.ini found; preinstalling dependencies..."
            pio pkg install --global || true
            pio pkg install || true
          else
            echo "No platformio.ini at repo root; skipping PlatformIO preinstall."
          fi

      # Optional: prove it compiles (helps Copilot stop failing due to missing deps/toolchains).
      - name: PlatformIO - Build (best effort)
        shell: bash
        run: |
          if [ -f "platformio.ini" ]; then
            echo "Attempting PlatformIO build..."
            pio run
          else
            echo "No platformio.ini at repo root; skipping build."
          fi

      # Optional web deps: looks for common web roots; adjust paths to match your repo.
      - name: Set up Node (only if web UI exists)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Web UI deps (best effort)
        shell: bash
        run: |
          set -e
          for d in web ui frontend dashboard; do
            if [ -f "$d/package.json" ]; then
              echo "Found $d/package.json; installing deps..."
              (cd "$d" && npm ci)
            fi
          done
          echo "Web dependency install step complete."
